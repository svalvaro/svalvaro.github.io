---
title: "A comprehensive analysis of market sales"
description: "TBD"
author:
  - name: Álvaro Sánchez
    url: https://svalvaro.github.io/
date: 11-19-2024
categories: [R, time series]
image: tbd
draft: true 
freeze: true
code-fold: true
---

# Time Series Analysis
We'll be using a sales dataset from a supermakert chain [source](https://www.kaggle.com/datasets/aungpyaeap/supermarket-sales?resource=download).

```{r,  message=FALSE, expan}
dataset <- readr::read_csv("data.csv")
```

```{r}
head(dataset) |> 
  kableExtra::kable("html") 
```

Let's have a look at what the data looks like
```{r}
dplyr::glimpse(dataset)
```

# What are these folks buying?
Let's check what are people buying...


```{r, message = FALSE, fig.height=8, fig.width=8, warning=FALSE}
library(ggplot2)
library(ggstream)
library(cowplot)
library(dplyr)

# Let's aggregate the data
data_product <- dataset |> 
  mutate(
    formatted_date = lubridate::mdy(Date)
  ) |> 
  group_by(Branch, formatted_date, `Product line`) |>
  summarise(
    n_products_sold = sum(Quantity),
    .groups = "drop"
  )

# A function that we can use to plot the sales for the products at any branch
stream_plot <- function(data, branch) {
  data |> 
  filter(Branch == branch) |> 
    ggplot(aes(x = formatted_date, y = n_products_sold, fill = `Product line`)) +
      geom_stream(type="proportion") +
      scale_fill_manual(values= c("#6d2f20", "#df7e66", "#e09351", "#edc775", "#94b594", "#224b5e")) +
      theme_void() 
}

plot_a <- stream_plot(data_product, "A") + 
      theme(legend.position = "none")
plot_b <- stream_plot(data_product, "B")+ 
      theme(legend.position = "none")
plot_c <- stream_plot(data_product, "C") +
    theme(
      legend.position = c(0.5, 0.05),
      legend.direction = "horizontal",
      legend.text = element_blank(),
      legend.title = element_blank(),
      legend.key.height = unit(0.75, "cm"),
      legend.key.width = unit(3, "cm")
      ) +
  guides(fill = guide_legend(nrow = 1))

# Let's put everything together
source("helper_functions.R")
ggdraw(plot_grid(plot_a, plot_b, plot_c, ncol=1)) +
  theme(plot.background = element_rect(fill="#fbf7f0", color="#fbf7f0"),
        plot.margin = margin(50, 30, 30)) +
  draw_text(text = "Number of Product Sales", x=0.5, y=1.15, fontface="bold", size= 30, family=font1, color="#4f2217") +
  draw_text(text="Jan", x=0.05, y=1.023, size=15, family=font2, color="#4f2217") +
  draw_text(text="Feb", x=0.35, y=1.023, size=15, family=font2, color="#4f2217") +
  draw_text(text="Mar", x=0.65, y=1.023, size=15, family=font2, color="#4f2217") +
  draw_text(text="Apr", x=0.95, y=1.023, size=15, family=font2, color="#4f2217") +
  draw_text(text="Electronics", x=0.1, y=-0.0385, size=10, family=font2, fontface="bold", color="#fbf7f0") +
  draw_text(text="Fashion", x=0.233, y=0.01, size=10, family=font2, fontface="bold", color="#fbf7f0") +
  draw_text(text="Food & Beverages", x=0.368, y=-0.05, size=10, family=font2, fontface="bold", color="grey15") +
  draw_text(text="Health & Beauty", x=0.501, y=-0.0385, size=10, family=font2, fontface="bold", color="grey15") +
  draw_text(text="Home & Lifestyle", x=0.634, y=-0.037, size=10, family=font2, fontface="bold", color="grey15") +
  draw_text(text="Sports & Travel", x=0.768, y=-0.0385, size=10, family=font2, fontface="bold", color="grey15") +
  draw_text(text="Branch A", x=0.97, y=0.8, size=15, family=font1, hjust=0, color="#4f2217") +
  draw_text(text="Branch B", x=0.97, y=0.5, size=15, family=font1, hjust=0, color="#4f2217") +
  draw_text(text="Branch C", x=0.97, y=0.2, size=15, family=font1, hjust=0, color="#4f2217") 



```
# Daily sales
```{r, message= FALSE}
library(dplyr)
library(lubridate)

summary <- dataset |> 
  mutate(
    formatted_date = lubridate::mdy(Date)
  ) |> 
  group_by(Branch, formatted_date) |>
  summarise(
    sum_sales = sum(Total),
    .groups = "drop"
  )

summary |> 
  head() |> 
  kableExtra::kable("html") 
```



We can use ggplot2 for visualising the data

```{r, collapse=TRUE, message=FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)
library(viridis)

# I'll load a custom theme

source("helper_functions.R")

temp_summary <- summary |> 
  mutate(name_branch = Branch)

temp_summary |> 
  ggplot(aes(x = formatted_date, y = sum_sales)) +
    geom_line( data=temp_summary %>% dplyr::select(-Branch), aes(group=name_branch), color="grey", size=0.5, alpha=0.5) +
    geom_line( aes(color = Branch), color="#69b3a2", size=1.2 )+
    scale_color_viridis(discrete = TRUE) +
    custom_theme() +
    theme(
      legend.position="none",
      plot.title = element_text(size=14),
      axis.title.y = element_blank(),
      axis.title.x = element_blank()
    ) +
    labs(
      title = "Daily Sales ($)",
      subtitle = "Daily sales in the first quarter of 2019 in three different branches",
      caption = "https://svalvaro.github.io/"
      
    ) + 
    facet_wrap(~Branch, ncol = 1)
```



Let's add some interactivity and use the plotly library 